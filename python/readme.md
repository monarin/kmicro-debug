# Python Utilities

This directory contains Python scripts for analyzing and configuring the KMicroscope system.

---

## 🚀 Available Scripts

### 1. `pulseid_regression_checker.py`

#### 📚 Description
- Parses and analyzes `bulk.txt` to check for pulse ID regressions.
- Identifies corrupted pulse IDs, detects bit flips, and reports differences between consecutive pulse IDs.
- Generates a detailed summary of any detected regressions and prints the results to the console.

#### 📄 Dependencies
- Requires `bulk.txt` file generated by `user_callbacks_pipe`.

#### 📊 Usage
```bash
# Run the pulse ID regression checker
python3 pulseid_regression_checker.py ../data/bulk.txt
```

#### 📈 Sample Output
```
⚠️ Pulse ID regressions detected:

At line 1034:
  Previous Pulse ID (line 1033): 1A2B3C4D5678EF
  Current  Pulse ID (line 1034): 1A2B3C4D5600FF
  Difference: -256
  Type: Drop to zero
  Dropped 3 bits at positions: [24, 25, 26]
```
If no regressions are found:
```
✅ No pulse ID regressions detected.
```

---

### 2. `set_generators.py`

#### 📚 Description
- Configures the electron event generator to set the desired number of active spectrum generators.
- Connects to the generator via USB and communicates with the device using the `DldSimulator` class.
- Retrieves the current number of active generators and optionally updates it.

#### ⚠️ Important Note
- The electron event generator is connected to **two USB devices: USB0 and USB1**, but **only USB0** is used for setting the registers.
- This script should be run **on the node that the electron event generator is connected to** for successful communication.

#### 📄 Dependencies
- `pyserial` package to communicate with the USB device.
- `DldSimulator` module for controlling the electron event generator.

#### 📊 Usage
```bash
# Run the generator configuration script
python3 set_generators.py <num_of_generators>
```

#### 📈 Example
```bash
# Set 5 active generators
python3 set_generators.py 5
```

#### 🔍 Verifying USB Connection
To verify that the generator is connected to the expected USB ports:
```bash
# List connected USB devices
ls /dev/ttyUSB*

# Check USB device assignments
dmesg | grep ttyUSB
```
Expected output:
```
[   34.123456] usb 1-1.2: cp210x converter now attached to ttyUSB0
[   34.123789] usb 1-1.3: cp210x converter now attached to ttyUSB1
```

If the generator is detected on `ttyUSB0`, you can proceed with running the script.

---

## 📄 Additional Notes

- `pulseid_regression_checker.py` expects the `bulk.txt` file to be located in the `data/` directory.
- `set_generators.py` should be executed from the `python/` directory and requires a valid connection to the electron event generator via USB.

---

## 📚 Troubleshooting

### 1. **Device Not Detected**
If `set_generators.py` fails to detect the device on `/dev/ttyUSB0`, try checking the connection:
```bash
dmesg | grep ttyUSB
```

### 2. **Permission Denied for USB Device**
If you encounter a permission error:
```bash
sudo chmod 666 /dev/ttyUSB0
```

### 3. **Missing Required Package**
If `pyserial` is missing, install it:
```bash
pip install pyserial
```

---

## 🤝 Contributing

If you’d like to contribute or improve these scripts, feel free to submit a pull request or open an issue!


